<html>
<head>
	<style type="text/css">
		#wrapper{
		    position:relative;
		    width:400px;
		    height:400px;
		}
		#motorCanvas,#angleCanvas,#hornCanvas{
		    position:absolute; top:0px; left:0px;
		    width:400px;
		    height:400px;
		}
	</style>
</head>
<body>
	<div id="wrapper">
		<canvas id="motorCanvas" width="400" height="400" style="border:1px solid #000000; z-index: 0">
		</canvas>
		<canvas id="angleCanvas" width="400" height="400" style="border:1px solid #000000; z-index: 1">
		</canvas>
		<canvas id="hornCanvas" width="400" height="400" style="border:1px solid #000000; z-index: 2">
		</canvas>
	</div>
	<script>
		var httpRequest = new XMLHttpRequest();

		var motorCanvas = document.getElementById("motorCanvas");
		var motorContext = motorCanvas.getContext("2d");

		var angleCanvas = document.getElementById("angleCanvas");
		var angleContext = angleCanvas.getContext("2d");

		var hornCanvas = document.getElementById("hornCanvas");
		var hornContext = hornCanvas.getContext("2d");

		var mousedown = false;

		var motor1 = {
			name: "Motor 1",
			motorid: 1,
			x: 200,
			y: 200,
			maxAngle: 180,
			minAngle: 0,
			angle: 0,
			hornLength: 100 
		};

		drawMotorBase(motorContext,motor1);
		drawAngle(angleContext,motor1);
		drawHorn(hornContext,motor1);

		hornCanvas.addEventListener('mousedown', function (e) {mousedown = true; mouseMoved(e)}, false);
		hornCanvas.addEventListener('mousemove', mouseMoved, false);
		hornCanvas.addEventListener('mouseup', function () {mousedown = false}, false);

		function mouseMoved(event) {
			if (mousedown) {
				var dx = event.clientX -200, dy = event.clientY - 200;
				motor1.angle = Math.atan2(dx, dy) * 180 / Math.PI;
				drawHorn(hornContext, motor1);
				send();
			}
		}

		function drawAngle(ctx, motor) {
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.clearRect(0, 0, motorCanvas.width, motorCanvas.height);
			ctx.save();

			ctx.translate(motor.x, motor.y);
			ctx.rotate(-Math.PI/2);
			ctx.strokeStyle = "#000000";
			ctx.lineWidth = 1;

			ctx.beginPath();
			for (angle = 0; angle <= 180; angle += 5) {
				lineLength = angle % 45 == 0 ? 15 : 10;
				ctx.save();
				ctx.rotate(angle * Math.PI / 180);
				ctx.moveTo(motor.hornLength, 0);
				ctx.lineTo(motor.hornLength + lineLength,0);
				ctx.restore();
			}
			ctx.stroke();
		}

		function drawHorn(ctx, motor) {
			console.log(motor.angle);
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.clearRect(0, 0, motorCanvas.width, motorCanvas.height);
			ctx.save();

			ctx.translate(motor.x,motor.y);
			ctx.rotate((-motor.angle+90)*Math.PI/180);

			ctx.beginPath();
			ctx.strokeStyle = "#000000";
			ctx.lineWidth = 10;
			ctx.moveTo(0,0);
			ctx.lineTo(motor.hornLength - 20,0);
			ctx.stroke();
			ctx.closePath();
			ctx.beginPath();
			ctx.lineWidth = 1;
			ctx.fillStyle = '#000000';
			ctx.arc(0, 0, 8, 0, 2 * Math.PI);
			ctx.fill();
			ctx.closePath();
			ctx.beginPath();
			ctx.lineWidth = 3;
		    ctx.globalAlpha = 0.5;
			ctx.fillStyle = '#157E15';
			ctx.arc(0+100, 0, 20, 0, 2 * Math.PI);
			ctx.fill();
		    ctx.globalAlpha = 1;
			ctx.stroke();
			ctx.closePath();

			ctx.restore();
		}

		function drawMotorBase(ctx, motor) {
			ctx.setTransform(1, 0, 0, 1, 0, 0);
			ctx.clearRect(0, 0, motorCanvas.width, motorCanvas.height);
			ctx.save();

			ctx.translate(-224.236 + motor.x, -119.888 + motor.y);
			ctx.scale(4, 4);
			ctx.fillStyle = "#ffffff";
			ctx.strokeStyle = "rgba(0,0,0,255)";
			ctx.lineWidth = 0.2;
			ctx.beginPath();
			ctx.moveTo(21.775,20.869);
			ctx.lineTo(70.446,20.869);
			ctx.quadraticCurveTo(72.976,20.869,72.976,23.398);
			ctx.lineTo(72.976,36.546);
			ctx.quadraticCurveTo(72.976,39.075,70.446,39.075);
			ctx.lineTo(21.775,39.075);
			ctx.quadraticCurveTo(19.245,39.075,19.245,36.546);
			ctx.lineTo(19.245,23.398);
			ctx.quadraticCurveTo(19.245,20.868,21.775,20.869);
			ctx.moveTo(28.168,20.866);
			ctx.lineTo(64.053,20.866);
			ctx.quadraticCurveTo(65.160,20.866,65.160,21.973);
			ctx.lineTo(65.160,37.970);
			ctx.quadraticCurveTo(65.160,39.077,64.053,39.078);
			ctx.lineTo(28.168,39.078);
			ctx.quadraticCurveTo(27.060,39.078,27.060,37.970);
			ctx.lineTo(27.060,21.973);
			ctx.quadraticCurveTo(27.060,20.866,28.168,20.866);
			ctx.moveTo(25.116,29.972);
			ctx.arc(23.116,29.972,2.001,0,Math.PI*2,true);
			ctx.moveTo(71.105,29.972);
			ctx.arc(69.105,29.972,2.001,0,Math.PI*2,true);
			ctx.moveTo(56.059,20.883);
			ctx.translate(56.073,29.972);
			ctx.arc(0,0,9.08,-1.572,-2.283185307179586,1);
			ctx.translate(-9.979,0);
			ctx.arc(0,0,6.204,-1.105,-Math.PI/2,1);
			ctx.arc(0,0,6.204,-1.570,-Math.PI,1);
			ctx.arc(0,0,6.204,-3.141,-Math.PI*1.5,1); 
			ctx.arc(0,0,6.204,1.569,1.1091150706809816,1);
			ctx.translate(9.961,0);
			ctx.arc(0,0,9.089,2.484,Math.PI*1.5,1);
			ctx.translate(-56.059,-29.972);
			ctx.moveTo(59.165,29.972);	
			ctx.arc(56.059,29.972,3.106,0,Math.PI*2,true);
			ctx.moveTo(47.421,29.972);	
			ctx.arc(46.110,29.972,1.311,0,Math.PI*2,true);
			ctx.closePath();
			ctx.stroke();
			ctx.restore();
		}

		function send(args) {
			var obj = {
				commands : [{
					code : "G",
					data : [
						0,
						Math.round(motor1.angle),
						1000
					]
				}]
			};
			httpRequest.open("POST", "/", true);
			httpRequest.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			httpRequest.send(JSON.stringify(obj));
		}
	</script> 
</body>
</html>