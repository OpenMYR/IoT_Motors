Import('base_env')

# This is a bit of a hack. We couldn't get variant_dir working with the way
# SCons manages dependencies and get the firmware in the bin folder,
# so we just hardcoded the bin folder into the commands
base_env.Command(['bin/stepper_driver-0x00000.bin', 'bin/stepper_driver-0x40000.bin'], 'out/stepper_driver', 'esptool.py elf2image $SOURCE --output build/bin/stepper_driver-')
base_env.Command(['bin/quad_servo_driver-0x00000.bin', 'bin/quad_servo_driver-0x40000.bin'], 'out/quad_servo_driver', 'esptool.py elf2image $SOURCE --output build/bin/quad_servo_driver-')

base_env.Alias('quad', 'bin/quad_servo_driver-0x00000.bin')
base_env.Alias('stepper', 'bin/stepper_driver-0x00000.bin')

base_env.Alias('flash-quad', base_env.Command(None, ['bin/quad_servo_driver-0x00000.bin', 'bin/quad_servo_driver-0x40000.bin'], 'esptool.py --port /dev/ttyAMA0 write_flash 0x00000 build/bin/quad_servo_driver-0x00000.bin 0x40000 build/bin/quad_servo_driver-0x40000.bin'))
base_env.Alias('flash-stepper', base_env.Command(None, ['bin/stepper_driver-0x00000.bin', 'bin/stepper_driver-0x40000.bin'], 'esptool.py --port /dev/ttyAMA0 write_flash 0x00000 build/bin/stepper_driver-0x00000.bin 0x40000 build/bin/stepper_driver-0x40000.bin'))

Clean('.', 'bin')
Clean('.', 'out')

if GetOption("clean"):
	Default('.')

# Link and run unit tests
Import('test_env')

test_env.stepper_queue_test_prog = test_env.Program('bin/test/stepper_queue_test', ['out/test/cmocka.o', 'out/test/stepper_op_queue.o'])
test_env.quad_queue_test_prog = test_env.Program('bin/test/quad_queue_test', ['out/test/cmocka.o', 'out/test/quad_op_queue.o'])

test_env.stepper_queue_test = test_env.Alias('stepper-queue-test', test_env.Command('bin/test/log/stepper_queue_test.log', test_env.stepper_queue_test_prog, 'build/bin/test/stepper_queue_test > $TARGET'))
test_env.quad_queue_test = test_env.Alias('quad-queue-test', test_env.Command('bin/test/log/quad_queue_test.log', test_env.quad_queue_test_prog, 'build/bin/test/quad_queue_test > $TARGET'))

test_env.run_tests = Alias('test', [test_env.stepper_queue_test, test_env.quad_queue_test])

Default('test', 'quad', 'stepper')
